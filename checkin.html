<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Чек-ин в спортзал</title>
<script>
// === НАСТРОЙКА ===
const scriptUrl = "https://script.google.com/macros/s/AKfycbzBzRgAnu8ge3bu09B0CQYzY2bdoFlD_G9ZpjM_6H8AgI0rMssUGW7o6xtdywEGqcHu/exec";
const formBase = "https://docs.google.com/forms/d/e/1FAIpQLSerXYjr43HlTwdgJDcE53icDd5jVoUQdwWlarxG4ugJbPNxSw/formResponse";

// === ГЕНЕРАЦИЯ ТОКЕНА ===
function getOrCreateToken() {
  const match = document.cookie.match(/token=([a-zA-Z0-9_-]+)/);
  if (match) return match[1];
  const token = Math.random().toString(36).substring(2, 12);
  document.cookie = `token=${token}; path=/; max-age=31536000`; // 1 год
  return token;
}

// === ПОЛУЧЕНИЕ СЕКЦИИ И deviceID ===
async function initCheckin() {
  const section = new URLSearchParams(window.location.search).get("section") || "unknown";
  const token = getOrCreateToken();

  try {
    const resp = await fetch(`${scriptUrl}?token=${token}`);
    const data = await resp.json();
    const deviceID = data.deviceID || "unknown";

    const formUrl = `${formBase}?entry.1807815869=&entry.830912820=${encodeURIComponent(section)}&entry.1858340664=${encodeURIComponent(deviceID)}`;
    window.location.href = formUrl;
  } catch (err) {
    document.body.innerHTML = `<p>Ошибка соединения. Попробуйте позже.</p>`;
    console.error(err);
  }
}

window.onload = initCheckin;
</script>
</head>
<body>
<p>Перенаправляем в форму… ⏳</p>
</body>
</html>
