<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Чек-ин в спортзал</title>
<style>
body {
    font-family: Arial, sans-serif;
    text-align: center;
    padding: 50px;
    background: #f5f5f5;
}
.loader {
    border: 5px solid #f3f3f3;
    border-top: 5px solid #007cba;
    border-radius: 50%;
    width: 50px;
    height: 50px;
    animation: spin 1s linear infinite;
    margin: 20px auto;
}
@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
</style>
<script>
// === НАСТРОЙКА ===
const scriptUrl = "https://script.google.com/macros/s/AKfycbyj5XEC5_yHHEFfI8yciabymMG1hE5svywehH3iwYsBhWUZdBvuaidvvYNXW7uDk5rJ/exec";
const formBase = "https://docs.google.com/forms/d/e/1FAIpQLSerXYjr43HlTwdgJDcE53icDd5jVoUQdwWlarxG4ugJbPNxSw/viewform";

// === СУПЕР-БЫСТРАЯ ВЕРСИЯ ===
async function initCheckin() {
    // 1. Сразу проверяем localStorage (мгновенно)
    const cached = localStorage.getItem('deviceCache');
    
    if (cached) {
        const { deviceID, expires } = JSON.parse(cached);
        // Кэш валиден 24 часа
        if (Date.now() < expires) {
            window.location.href = `${formBase}?entry.1721493995=${encodeURIComponent(deviceID)}`;
            return; // РЕДИРЕКТ ЗА 0.01 СЕКУНДЫ!
        }
    }
    
    // 2. Быстро получаем/генерируем токен
    let token = document.cookie.match(/token=([a-zA-Z0-9_-]+)/)?.[1];
    if (!token) {
        token = Math.random().toString(36).substring(2, 12);
        document.cookie = `token=${token}; path=/; max-age=31536000`;
    }
    
    // 3. Показываем форму сразу, параллельно получая deviceID
    document.getElementById('status').textContent = "Открываем форму...";
    
    // 4. Таймаут для Google Apps Script - не ждём больше 2 секунд
    const timeoutPromise = new Promise((_, reject) => 
        setTimeout(() => reject(new Error('Timeout')), 2000)
    );
    
    try {
        // Пытаемся быстро получить deviceID
        const resp = await Promise.race([
            fetch(`${scriptUrl}?token=${token}`),
            timeoutPromise
        ]);
        
        const data = await resp.json();
        const deviceID = data.deviceID || "unknown";
        
        // Кэшируем на 24 часа
        localStorage.setItem('deviceCache', JSON.stringify({
            deviceID,
            expires: Date.now() + 24 * 60 * 60 * 1000
        }));
        
        window.location.href = `${formBase}?entry.1721493995=${encodeURIComponent(deviceID)}`;
        
    } catch (err) {
        // Если Google Apps Script медленный или недоступен
        console.log("Используем быстрый фолбэк");
        
        // Генерируем локальный deviceID
        const localDeviceID = 'LOCAL-' + Math.random().toString(36).substring(2, 10);
        
        // Кэшируем локальный ID
        localStorage.setItem('deviceCache', JSON.stringify({
            deviceID: localDeviceID,
            expires: Date.now() + 24 * 60 * 60 * 1000
        }));
        
        // Открываем форму СРАЗУ
        window.location.href = `${formBase}?entry.1721493995=${encodeURIComponent(localDeviceID)}`;
    }
}

// Запускаем МГНОВЕННО
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initCheckin);
} else {
    initCheckin(); // Если страница уже загружена
}
</script>
</head>
<body>
    <div class="loader"></div>
    <p id="status">Подготовка...</p>
</body>
</html>
